import asyncio
from enum import Enum

import httpx
from playwright.async_api import async_playwright, Playwright, Page

from crawler import log
from crawler.config import settings
from projects.gap.gap import open_pdp_page

# urls = [
#     {
#         "women": [
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=0",
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=1",
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=2",
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=3",
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=4",
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=5",
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=6",
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=7",
#             "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=8",
#         ]
#     },  # 女装 2804
#     {"men.all": "https://www.gap.com/browse/category.do?cid=1127944&department=75"},  # 男装 约1009
# ]
source = "gap"
sub_category = "default"  # 商品子类别
urls = [
    ("men", sub_category, "https://www.gap.com/browse/category.do?cid=1127944&department=75&pageId=0"),
    ("men", sub_category, "https://www.gap.com/browse/category.do?cid=1127944&department=75&pageId=1"),
    ("men", sub_category, "https://www.gap.com/browse/category.do?cid=1127944&department=75&pageId=2"),
    ("men", sub_category, "https://www.gap.com/browse/category.do?cid=1127944&department=75&pageId=3"),
    ("men", sub_category, "https://www.gap.com/browse/category.do?cid=1127944&department=75&pageId=4"),
]
# urls = [
#     # (
#     #     "women",
#     #     sub_category,
#     #     "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=0",
#     # ),
#     # (
#     #     "women",
#     #     sub_category,
#     #     "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=1",
#     # ),
#     # (
#     #     "women",
#     #     sub_category,
#     #     "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=2",
#     # ),
#     # (
#     #     "women",
#     #     sub_category,
#     #     "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=3",
#     # ),
#     # (
#     #     "women",
#     #     sub_category,
#     #     "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=4",
#     # ),
#     (
#         "women",
#         sub_category,
#         "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=5",
#     ),
#     (
#         "women",
#         sub_category,
#         "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=6",
#     ),
#     (
#         "women",
#         sub_category,
#         "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=7",
#     ),
#     (
#         "women",
#         sub_category,
#         "https://www.gap.com/browse/category.do?cid=1127938&department=136#department=136&pageId=8",
#     ),
# ]
# primary_category = "boys"  # 商品主类别
# sub_category = "default"  # 商品子类别
# urls = [("boys", "default", "https://www.gap.com/browse/category.do?cid=6189&department=16")]
PLAYWRIGHT_TIMEOUT: int = settings.playwright.timeout or 1000 * 60
print(PLAYWRIGHT_TIMEOUT)
PLAYWRIGHT_CONCURRENCY: int = settings.playwright.concurrency or 10
PLAYWRIGHT_CONCURRENCY: int = 1
PLAYWRIGHT_HEADLESS: bool = settings.playwright.headless
# PLAYWRIGHT_HEADLESS: bool = True
should_use_proxy = False
__doc__ = """
    金茂爬虫, 主要通过按类别爬取和按搜索爬取两种方式
"""


class Category(Enum):
    girls = "14417"


# 这个函数负责启动一个浏览器，打开一个新页面，并在页面上执行操作。
# 它接受一个Playwright对象作为参数。


def get_product_id(url: str) -> str:
    parsed_url = httpx.URL(url)
    return parsed_url.params.get("pid")[:-3]


async def run(playwright: Playwright, urls: list[tuple]) -> None:
    # 从playwright对象中获取chromium浏览器
    chromium = playwright.chromium
    # 指定代理
    # proxy = {"server": "http://127.0.0.1:7890"}
    # 启动chromium浏览器，开启开发者工具，非无头模式
    # browser = await chromium.launch(headless=False, devtools=True)
    if should_use_proxy:
        proxy = {
            "server": settings.proxy_pool.server,
            "username": settings.proxy_pool.username,
            "password": settings.proxy_pool.password,
        }
    else:
        proxy = None
    user_data_dir = settings.user_data_dir
    if settings.save_login_state:
        context = await playwright.chromium.launch_persistent_context(
            user_data_dir,
            headless=PLAYWRIGHT_HEADLESS,
            proxy=proxy,
            # headless=False,
            # slow_mo=50,  # 每个操作的延迟时间（毫秒），便于调试
            args=["--start-maximized"],  # 启动时最大化窗口
            # ignore_https_errors=True,  # 忽略HTTPS错误
            # devtools=True,  # 打开开发者工具
        )
    else:
        browser = await chromium.launch(headless=True, devtools=True, proxy=proxy)
        context = await browser.new_context()

    # 设置全局超时
    context.set_default_timeout(settings.playwright.timeout)
    # 创建一个新的浏览器上下文，设置视口大小
    # context = await browser.new_context(viewport={"width": 1920, "height": 1080})
    # 在浏览器上下文中打开一个新页面

    # 并发抓取商品
    semaphore = asyncio.Semaphore(PLAYWRIGHT_CONCURRENCY)  # 设置并发请求数限制为10
    log.debug(f"并发请求数: {PLAYWRIGHT_CONCURRENCY}")
    tasks = []
    # TODO 修改此处参数
    sku_index = [("814639", "814639002")]
    sku_ids = [
        "545906002",
        "883550062",
        "409146032",
        "500584012",
        "508982002",
        "438023002",
        "411679012",
        "568218182",
        "431842002",
        "416638062",
        "260636432",
        "403540002",
        "728863002",
        "871386002",
        "1000185002",
        "869730052",
        "869726132",
        "558957002",
        "855967032",
        "356168652",
        "871336002",
        "729618122",
        "821866002",
        "880266022",
        "540687002",
        "568217092",
        "880878002",
        "875081002",
        "563012002",
        "869722092",
        "260230112",
        "406725002",
        "794579002",
        "803567002",
        "570868002",
        "1000191002",
        "429165002",
        "660018002",
        "1000187002",
        "448087002",
        "474285002",
        "479461042",
        "794965092",
        "821325052",
        "431253002",
        "407881002",
        "407882002",
        "431248002",
        "431256002",
        "563335002",
        "563007002",
        "562984002",
        "655107002",
        "373509102",
        "729652002",
        "670538042",
        "664665002",
        "586769012",
        "586732002",
        "576561002",
        "536721012",
        "870589022",
        "854755022",
        "890601042",
        "890842002",
        "871357002",
        "855745002",
        "855025002",
        "857632002",
        "905272032",
        "869732002",
        "890860002",
        "729783002",
        "885257002",
        "871372002",
        "464373002",
        "855965012",
        "429014002",
        "540610002",
        "592037022",
        "540609002",
        "523562052",
        "834853112",
        "260277012",
        "873269002",
        "848883292",
        "447979002",
        "659618002",
        "871510002",
        "540613002",
        "540615042",
        "841725002",
        "586039002",
        "431159002",
        "585582012",
        "1000130002",
        "857615012",
        "480071002",
        "889933002",
        "876107042",
        "803528002",
        "857272002",
        "871438002",
        "763097042",
        "790890012",
        "873500002",
        "853476002",
        "891995002",
        "540664002",
        "885270012",
        "755814342",
        "586063002",
        "870580002",
        "661059042",
        "871390002",
        "1000184002",
        "1000186002",
        "855189012",
        "592231052",
        "855740002",
        "558870002",
        "711766002",
        "431230002",
        "883001002",
        "504521002",
        "562295002",
        "410052002",
        "409151002",
        "871323002",
        "873266002",
        "857646002",
        "432356012",
        "806999002",
        "409154102",
        "873616002",
        "749402002",
        "1000189002",
        "1000196002",
        "558943002",
        "558851002",
        "871509002",
        "853453002",
        "855181002",
        "570975002",
        "1000193002",
        "1000195002",
        "474278002",
        "474300002",
        "475858002",
        "448029002",
        "1000135002",
        "1000136002",
        "468180002",
        "467557002",
        "443611002",
        "558861002",
        "562980002",
        "562999002",
        "563004002",
        "562982002",
        "469007002",
        "539614072",
        "569554002",
        "855193002",
        "854731022",
        "869173002",
        "563344002",
        "563377002",
        "875076002",
        "790919002",
        "870565002",
        "810502002",
        "729367012",
        "866810022",
        "838328002",
        "892218002",
        "885267002",
        "883004002",
        "884446002",
        "884441002",
        "882985002",
        "431601002",
        "871493002",
        "873397002",
        "464370002",
        "756653002",
        "570424002",
        "665864002",
        "882138002",
        "523563052",
        "891557002",
        "570479002",
        "873496002",
        "854613002",
        "852795002",
        "802546112",
        "570098002",
        "586765002",
        "772532002",
        "406849002",
        "853466002",
        "977167012",
        "570471002",
        "484999002",
        "803547002",
        "875997002",
        "860146032",
        "853455002",
        "857259002",
        "703503002",
        "853367002",
        "728757002",
        "571079002",
        "725276002",
        "817987002",
        "474292002",
        "1000194002",
        "448104002",
        "1000139002",
        "448163002",
        "438382002",
        "467558002",
        "431194002",
        "563359002",
        "562986002",
        "563002002",
        "563028002",
        "570930002",
        "514109012",
        "409147012",
        "586767002",
        "876171042",
        "875131002",
        "821307032",
        "607068022",
        "885306002",
        "790823002",
        "728756002",
        "801175082",
        "586771012",
        "570657032",
        "880359002",
        "870049002",
        "508797002",
        "870045002",
        "870308012",
        "891308002",
        "433077002",
        "484774002",
        "538544002",
        "703536002",
        "767285112",
        "853484002",
        "431270002",
        "607134002",
        "853372002",
        "852810002",
        "871457002",
        "853472002",
        "416427002",
        "615913002",
        "451501022",
        "431236002",
        "853457002",
        "541190062",
        "1169518002",
        "1169504002",
        "448066002",
        "571390002",
        "564498002",
        "475981002",
        "521943002",
        "479573002",
        "664970012",
        "409122022",
        "742352002",
        "721402002",
        "876170002",
        "876173002",
        "872134002",
        "872139002",
        "803676002",
        "876183002",
        "876282002",
        "876278002",
        "404582032",
        "708566012",
        "795299002",
        "729770002",
        "810824012",
        "708824052",
        "565000012",
        "880336012",
        "706814022",
        "540641002",
        "513541002",
        "876046002",
        "771691022",
        "825962012",
        "825968052",
        "819065042",
        "754014012",
        "851358002",
        "876195002",
        "736395022",
        "851299002",
        "745051012",
        "1169505002",
        "1169506002",
        "1169503002",
        "1169502002",
        "728747002",
        "709931002",
        "876255002",
        "826477002",
        "876176002",
        "709337012",
        "876264002",
        "505871002",
        "742330022",
        "792265012",
        "866823002",
        "1000243002",
        "1000246002",
        "835830002",
        "569075002",
        "542723012",
        "542894002",
        "670622032",
        "601259002",
        "741321052",
        "753357002",
        "778551002",
        "778679002",
        "682533012",
        "851343002",
        "851357002",
        "876280002",
        "569147002",
        "750149002",
        "708564022",
        "797975002",
        "795303002",
        "542693122",
        "542783002",
        "662339022",
        "873614002",
        "876325002",
        "446507002",
        "586766002",
        "794580012",
        "818313002",
        "873494002",
        "409527012",
        "1000249002",
        "563005002",
        "880265002",
        "816860022",
        "416417002",
        "513506002",
        "463709032",
        "415800042",
        "231856572",
        "706808062",
        "664974002",
        "790822002",
        "816857002",
        "795344012",
        "795398032",
        "857725002",
        "824315022",
        "823165002",
        "823673002",
        "684836022",
        "814639002",
        "795345022",
    ]
    products = [
        "795346",
        "883550",
        "409146",
        "500584",
        "508982",
        "438023",
        "411679",
        "568218",
        "431842",
        "416638",
        "260636",
        "403540",
        "818866",
        "794565",
        "558802",
        "421104",
        "421102",
        "558957",
        "855967",
        "356168",
        "871336",
        "729618",
        "821866",
        "880266",
        "540687",
        "568217",
        "880878",
        "875081",
        "563012",
        "421103",
        "260230",
        "406725",
        "794579",
        "852814",
        "570868",
        "558758",
        "892217",
        "660034",
        "562241",
        "448087",
        "474285",
        "479461",
        "794965",
        "821325",
        "431253",
        "407881",
        "407882",
        "431248",
        "431256",
        "563335",
        "563007",
        "562984",
        "655107",
        "373509",
        "729652",
        "670538",
        "664665",
        "586769",
        "586732",
        "576561",
        "536721",
        "870589",
        "854755",
        "890601",
        "890842",
        "871357",
        "855745",
        "855025",
        "857632",
        "905272",
        "869732",
        "890860",
        "729783",
        "885257",
        "871372",
        "464373",
        "855965",
        "429014",
        "540610",
        "592037",
        "540609",
        "523562",
        "834853",
        "260277",
        "873269",
        "848883",
        "447979",
        "659618",
        "871510",
        "540613",
        "540615",
        "841725",
        "586039",
        "431159",
        "585582",
        "1000130",
        "857615",
        "480071",
        "889933",
        "876107",
        "803528",
        "857272",
        "871438",
        "763097",
        "790890",
        "873500",
        "853476",
        "891995",
        "540664",
        "885270",
        "755814",
        "586063",
        "870580",
        "661059",
        "871390",
        "1000184",
        "1000186",
        "855189",
        "592231",
        "855740",
        "558870",
        "711766",
        "431230",
        "883001",
        "504521",
        "562295",
        "410052",
        "409151",
        "871323",
        "873266",
        "857646",
        "432356",
        "806999",
        "409154",
        "873616",
        "749402",
        "1000189",
        "1000183",
        "558943",
        "559065",
        "794603",
        "570897",
        "855181",
        "703551",
        "1000193",
        "1000195",
        "474278",
        "474300",
        "475858",
        "448029",
        "1000135",
        "1000136",
        "468180",
        "467557",
        "443611",
        "558861",
        "562980",
        "562999",
        "563004",
        "562982",
        "469007",
        "539614",
        "569554",
        "855193",
        "854731",
        "869173",
        "563344",
        "563377",
        "875076",
        "790919",
        "870565",
        "810502",
        "729367",
        "866810",
        "838328",
        "892218",
        "885267",
        "883004",
        "884446",
        "884441",
        "882985",
        "431601",
        "871493",
        "873397",
        "464370",
        "756653",
        "570424",
        "665864",
        "882138",
        "523563",
        "891557",
        "570479",
        "873496",
        "854613",
        "852795",
        "802546",
        "570098",
        "586765",
        "772532",
        "406849",
        "853466",
        "977167",
        "570471",
        "484999",
        "803547",
        "875997",
        "860146",
        "853455",
        "857259",
        "703505",
        "853477",
        "728757",
        "795399",
        "570955",
        "817987",
        "474292",
        "1000194",
        "448104",
        "1000139",
        "448163",
        "438382",
        "467558",
        "431194",
        "563359",
        "562986",
        "563002",
        "563028",
        "570930",
        "514109",
        "409147",
        "586767",
        "876171",
        "875131",
        "821307",
        "607068",
        "885306",
        "790823",
        "728756",
        "801175",
        "586771",
        "570657",
        "880359",
        "870049",
        "508797",
        "870045",
        "870308",
        "891308",
        "433077",
        "484774",
        "538544",
        "703536",
        "767285",
        "853484",
        "431270",
        "607134",
        "853372",
        "852810",
        "871457",
        "853472",
        "416427",
        "615913",
        "451501",
        "431236",
        "853457",
        "541190",
        "1169518",
        "1169504",
        "448066",
        "571390",
        "564498",
        "475981",
        "521943",
        "479573",
        "664970",
        "409122",
        "742352",
        "721402",
        "876170",
        "876173",
        "872134",
        "872139",
        "803676",
        "876183",
        "876282",
        "876278",
        "404582",
        "708566",
        "795299",
        "729770",
        "810824",
        "708824",
        "565000",
        "880336",
        "706814",
        "540641",
        "513541",
        "876046",
        "771691",
        "825962",
        "825968",
        "819065",
        "754014",
        "851358",
        "876195",
        "736395",
        "851299",
        "745051",
        "1169505",
        "1169506",
        "1169503",
        "1169502",
        "728747",
        "709931",
        "876255",
        "826477",
        "876176",
        "709337",
        "876264",
        "505871",
        "742330",
        "792265",
        "866823",
        "1000245",
        "1000090",
        "798281",
        "569075",
        "542723",
        "542894",
        "670622",
        "601259",
        "741321",
        "753357",
        "778551",
        "778679",
        "682533",
        "851343",
        "851357",
        "876280",
        "569147",
        "750149",
        "708564",
        "797975",
        "795303",
        "542693",
        "542783",
        "662339",
        "873614",
        "876325",
        "446507",
        "586766",
        "794580",
        "818313",
        "873494",
        "409527",
        "1000249",
        "563005",
        "880265",
        "816860",
        "416417",
        "513506",
        "463709",
        "415800",
        "231856",
        "706808",
        "664974",
        "790822",
        "816857",
        "795344",
        "795398",
        "857725",
        "824315",
        "823165",
        "823673",
        "684836",
        "814639",
        "795345",
    ]
    sku_index = zip(products, sku_ids)
    sku_index = [("440866002", "440866")]
    products = [
        "831714",
        "876972",
        "891210",
        "733481",
        "876899",
        "701485",
        "669887",
        "735905",
        "595342",
        "858571",
        "1169556",
        "564645",
    ]
    sku_ids = [
        "831714132",
        "876974002",
        "891210002",
        "733481192",
        "876899012",
        "701485162",
        "669887222",
        "735905112",
        "595342002",
        "858571032",
        "1169556002",
        "564645002",
    ]
    sku_index = zip(products, sku_ids)

    sku_index = [("879147", "879147002")]
    main_category = "boys"
    sub_category = "default"
    for product_id, sku_id in sku_index:
        tasks.append(
            open_pdp_page(
                context,
                semaphore,
                product_id,
                sku_id,
                main_category=main_category,
                sub_category=sub_category,
                source=source,
            )
        )

    result = await asyncio.gather(*tasks)
    log.info(f"获取到的商品sku_id 列表: {result}")

    # break
    # 商品摘取完毕
    # 关闭浏览器context
    log.info("商品抓取完毕, 关闭浏览器")
    await context.close()


async def go_to_pdp_page(semapage: Page, pdp_url: str):
    # TODO  并发获取商品
    pass


# 这个函数是脚本的主入口点。
# 它创建一个playwright对象，并将其传递给run函数。
async def main():
    # 创建一个playwright对象并将其传递给run函数
    async with async_playwright() as p:
        await run(p, urls)
        ...


# 这是脚本的入口点。
# 它开始执行main函数。
if __name__ == "__main__":
    # 指定本地代理
    asyncio.run(main())
